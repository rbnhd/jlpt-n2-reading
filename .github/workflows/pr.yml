name: PR Validation Checks

# Controls when the workflow will run
on:
  # Triggers on PR to main branch
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**/README.md'
      - '**/LICENSE'
      - '**/.local/**'

  # Allows to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions
permissions:
  contents: read
  pull-requests: write  # Allow commenting on PRs

jobs:
  # JSON validation job
  validate-json:
    name: Validate JSON Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate all JSON files
        run: |
          echo "ğŸ” Validating JSON files..."
          EXIT_CODE=0
          
          # Find all JSON files and validate them
          for file in $(find . -name "*.json" -not -path "*/node_modules/*" -not -path "*/.git/*"); do
            echo "Checking: $file"
            if ! jq empty "$file" 2>/dev/null; then
              echo "âŒ Invalid JSON: $file"
              EXIT_CODE=1
            else
              echo "âœ… Valid: $file"
            fi
          done
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… All JSON files are valid!"
          else
            echo "âŒ Some JSON files have syntax errors!"
          fi
          
          exit $EXIT_CODE

  # HTML validation job
  validate-html:
    name: Validate HTML Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install HTML validator
        run: npm install -g html-validate
      
      - name: Create HTML validation config
        run: |
          cat > .htmlvalidate.json << 'EOF'
          {
            "extends": ["html-validate:recommended"],
            "rules": {
              "no-inline-style": "off",
              "require-sri": "off",
              "no-trailing-whitespace": "off",
              "no-implicit-button-type": "off",
              "unique-landmark": "off",
              "void-style": "off",
              "no-redundant-role": "off"
            }
          }
          EOF
      
      - name: Validate HTML files
        run: |
          echo "ğŸ” Validating HTML syntax (critical errors only)..."
          html-validate "*.html" "pages/*.html" || exit 1
          echo "âœ… All HTML files have valid syntax!"

  # CSS validation job
  validate-css:
    name: Validate CSS Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Validate CSS syntax
        run: |
          echo "ğŸ” Validating CSS syntax (critical errors only)..."
          EXIT_CODE=0
          
          # Use Node.js to validate CSS syntax
          for file in css/*.css; do
            echo "Checking: $file"
            
            # Simple syntax check using Node.js
            node -e "
              const fs = require('fs');
              const css = fs.readFileSync('$file', 'utf8');
              
              // Check for basic syntax errors
              const openBraces = (css.match(/{/g) || []).length;
              const closeBraces = (css.match(/}/g) || []).length;
              
              if (openBraces !== closeBraces) {
                console.error('âŒ Unmatched braces in $file');
                process.exit(1);
              }
              
              // Check for unterminated strings
              const lines = css.split('\n');
              lines.forEach((line, i) => {
                const singleQuotes = (line.match(/'/g) || []).length;
                const doubleQuotes = (line.match(/\"/g) || []).length;
                if (singleQuotes % 2 !== 0 || doubleQuotes % 2 !== 0) {
                  // Skip lines with escaped quotes
                  if (!line.includes('\\\\\"') && !line.includes(\"\\\\'\")){
                    console.warn('âš ï¸  Possible unterminated string at line ' + (i+1) + ' in $file');
                  }
                }
              });
              
              console.log('âœ… Valid: $file');
            " || EXIT_CODE=1
          done
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… All CSS files have valid syntax!"
          else
            echo "âŒ Some CSS files have critical syntax errors!"
          fi
          
          exit $EXIT_CODE

  # JavaScript validation job
  validate-javascript:
    name: Validate JavaScript Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install ESLint
        run: npm install -g eslint@8
      
      - name: Create ESLint config (legacy format for ESLint 8)
        run: |
          cat > .eslintrc.json << 'EOF'
          {
            "env": {
              "browser": true,
              "es2021": true
            },
            "extends": "eslint:recommended",
            "parserOptions": {
              "ecmaVersion": "latest",
              "sourceType": "module"
            },
            "rules": {
              "no-unused-vars": "off",
              "no-console": "off",
              "no-undef": "warn"
            }
          }
          EOF
      
      - name: Validate JavaScript files
        run: |
          echo "ğŸ” Validating JavaScript syntax (critical errors only)..."
          eslint "js/**/*.js" --quiet || exit 1
          echo "âœ… All JavaScript files have valid syntax!"

  # Link checker job
  check-links:
    name: Check for Broken Links
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check internal links
        run: |
          echo "ğŸ” Checking for broken internal links..."
          EXIT_CODE=0
          
          # Check if files referenced in HTML exist
          for html_file in $(find . -name "*.html" -not -path "*/node_modules/*"); do
            echo "Checking links in: $html_file"
            
            # Extract href and src attributes (simple grep, not perfect but good enough)
            grep -oP '(href|src)=["'\'']\K[^"'\'']*(?=["'\''])' "$html_file" 2>/dev/null | while read link; do
              # Skip external links, anchors, and data URIs
              if [[ "$link" =~ ^(http|https|mailto|tel|#|data:) ]]; then
                continue
              fi
              
              # Get directory of current HTML file
              dir=$(dirname "$html_file")
              
              # Resolve relative path
              if [[ "$link" = /* ]]; then
                # Absolute path from root
                target_file=".$link"
              else
                # Relative path
                target_file="$dir/$link"
              fi
              
              # Remove query strings and anchors
              target_file="${target_file%%\?*}"
              target_file="${target_file%%\#*}"
              
              # Check if file exists
              if [ ! -e "$target_file" ] && [ ! -d "$target_file" ]; then
                echo "âš ï¸  Broken link in $html_file: $link (target: $target_file not found)"
              fi
            done
          done
          
          echo "âœ… Link check complete!"

  # Data structure validation job
  validate-data-structure:
    name: Validate Data Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate passage structure
        run: |
          echo "ğŸ” Validating passage data structure..."
          EXIT_CODE=0
          
          for file in data/passages/*.json; do
            echo "Checking: $file"
            
            # Check required fields
            if ! jq -e '.id' "$file" > /dev/null 2>&1; then
              echo "âŒ Missing 'id' field in $file"
              EXIT_CODE=1
            fi
            if ! jq -e '.title' "$file" > /dev/null 2>&1; then
              echo "âŒ Missing 'title' field in $file"
              EXIT_CODE=1
            fi
            if ! jq -e '.category' "$file" > /dev/null 2>&1; then
              echo "âŒ Missing 'category' field in $file"
              EXIT_CODE=1
            fi
            if ! jq -e '.passage' "$file" > /dev/null 2>&1; then
              echo "âŒ Missing 'passage' field in $file"
              EXIT_CODE=1
            fi
            if ! jq -e '.questions' "$file" > /dev/null 2>&1; then
              echo "âŒ Missing 'questions' array in $file"
              EXIT_CODE=1
            fi
            
            # Check questions have required fields
            question_count=$(jq '.questions | length' "$file")
            if [ "$question_count" -eq 0 ]; then
              echo "âš ï¸  No questions found in $file"
            else
              echo "âœ… Found $question_count questions in $file"
            fi
          done
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… All passage files have valid structure!"
          else
            echo "âŒ Some passage files have structural issues!"
          fi
          
          exit $EXIT_CODE
      
      - name: Validate vocabulary structure
        run: |
          echo "ğŸ” Validating vocabulary data structure..."
          EXIT_CODE=0
          
          for file in data/vocabulary/*.json; do
            echo "Checking: $file"
            
            if ! jq -e '.items' "$file" > /dev/null 2>&1; then
              echo "âŒ Missing 'items' array in $file"
              EXIT_CODE=1
            else
              item_count=$(jq '.items | length' "$file")
              echo "âœ… Found $item_count vocabulary items in $file"
            fi
          done
          
          exit $EXIT_CODE
      
      - name: Validate grammar structure
        run: |
          echo "ğŸ” Validating grammar data structure..."
          
          file="data/grammar/grammar-n2-complete.json"
          if [ ! -f "$file" ]; then
            echo "âŒ Grammar file not found: $file"
            exit 1
          fi
          
          if ! jq -e '.patterns' "$file" > /dev/null 2>&1; then
            echo "âŒ Missing 'patterns' array in $file"
            exit 1
          fi
          
          pattern_count=$(jq '.patterns | length' "$file")
          echo "âœ… Found $pattern_count grammar patterns"
      
      - name: Validate metadata
        run: |
          echo "ğŸ” Validating content index metadata..."
          
          file="data/metadata/content-index.json"
          if [ ! -f "$file" ]; then
            echo "âŒ Metadata file not found: $file"
            exit 1
          fi
          
          if ! jq -e '.totalPassages' "$file" > /dev/null 2>&1; then
            echo "âŒ Missing 'totalPassages' in metadata"
            exit 1
          fi
          
          if ! jq -e '.passages' "$file" > /dev/null 2>&1; then
            echo "âŒ Missing 'passages' array in metadata"
            exit 1
          fi
          
          total=$(jq '.totalPassages' "$file")
          listed=$(jq '.passages | length' "$file")
          
          echo "Metadata reports: $total total passages"
          echo "Metadata lists: $listed passages"
          
          if [ "$total" -ne "$listed" ]; then
            echo "âš ï¸  Warning: totalPassages ($total) doesn't match passages array length ($listed)"
          fi
          
          echo "âœ… Metadata structure is valid!"

  # Summary job
  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-json, validate-html, validate-css, validate-javascript, check-links, validate-data-structure]
    if: always()
    permissions:
      pull-requests: write
    steps:
      - name: Check all validations passed
        id: check
        run: |
          echo "ğŸ“Š Validation Summary:"
          echo "====================="
          
          if [ "${{ needs.validate-json.result }}" = "success" ]; then
            echo "âœ… JSON validation: PASSED"
          else
            echo "âŒ JSON validation: FAILED"
          fi
          
          if [ "${{ needs.validate-html.result }}" = "success" ]; then
            echo "âœ… HTML validation: PASSED"
          else
            echo "âŒ HTML validation: FAILED"
          fi
          
          if [ "${{ needs.validate-css.result }}" = "success" ]; then
            echo "âœ… CSS validation: PASSED"
          else
            echo "âŒ CSS validation: FAILED"
          fi
          
          if [ "${{ needs.validate-javascript.result }}" = "success" ]; then
            echo "âœ… JavaScript validation: PASSED"
          else
            echo "âŒ JavaScript validation: FAILED"
          fi
          
          if [ "${{ needs.check-links.result }}" = "success" ]; then
            echo "âœ… Link checking: PASSED"
          else
            echo "âŒ Link checking: FAILED"
          fi
          
          if [ "${{ needs.validate-data-structure.result }}" = "success" ]; then
            echo "âœ… Data structure validation: PASSED"
          else
            echo "âŒ Data structure validation: FAILED"
          fi
          
          # Determine overall status
          if [ "${{ needs.validate-json.result }}" != "success" ] || \
             [ "${{ needs.validate-html.result }}" != "success" ] || \
             [ "${{ needs.validate-css.result }}" != "success" ] || \
             [ "${{ needs.validate-javascript.result }}" != "success" ] || \
             [ "${{ needs.validate-data-structure.result }}" != "success" ]; then
            echo ""
            echo "âŒ Some validation checks failed. Please fix the issues above."
            echo "overall_status=failed" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âœ… All validation checks passed! PR is ready to merge."
            echo "overall_status=passed" >> $GITHUB_OUTPUT
          fi
      
      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              json: '${{ needs.validate-json.result }}',
              html: '${{ needs.validate-html.result }}',
              css: '${{ needs.validate-css.result }}',
              javascript: '${{ needs.validate-javascript.result }}',
              links: '${{ needs.check-links.result }}',
              dataStructure: '${{ needs.validate-data-structure.result }}'
            };
            
            const status = '${{ steps.check.outputs.overall_status }}';
            const emoji = status === 'passed' ? 'âœ…' : 'âŒ';
            const title = status === 'passed' ? 'All Validation Checks Passed!' : 'Some Validation Checks Failed';
            
            const body = `## ${emoji} ${title}
            
            | Check | Status |
            |-------|--------|
            | JSON Validation | ${results.json === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |
            | HTML Validation | ${results.html === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |
            | CSS Validation | ${results.css === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |
            | JavaScript Validation | ${results.javascript === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |
            | Link Checking | ${results.links === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |
            | Data Structure Validation | ${results.dataStructure === 'success' ? 'âœ… Passed' : 'âŒ Failed'} |
            
            ${status === 'passed' ? 'ğŸ‰ This PR is ready to merge!' : 'âš ï¸ Please fix the failing checks before merging.'}
            
            <sub>Automated validation by PR workflow</sub>`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Automated validation by PR workflow')
            );
            
            // Update or create comment
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
      
      - name: Fail if checks failed
        if: steps.check.outputs.overall_status == 'failed'
        run: exit 1
